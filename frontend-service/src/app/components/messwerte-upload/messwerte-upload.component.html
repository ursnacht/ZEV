<div class="zev-container">
  <h1><app-icon name="upload" size="lg"></app-icon> {{ 'ZEV_MESSWERTE_UPLOAD' | translate }}</h1>

  @if (message) {
    <div class="zev-message" [ngClass]="'zev-message--' + messageType">
      {{ message }}
    </div>
  }

  <form (ngSubmit)="onSubmit()">
    <div class="zev-form-group">
      <label for="einheit">
        {{ 'EINHEIT' | translate }}:
        @if (isMatching) {
          <span class="zev-spinner-container">
            <span class="zev-spinner zev-spinner--small"></span>
            {{ 'EINHEIT_WIRD_ERKANNT' | translate }}
          </span>
        }
        @if (matchResult?.matched && (matchResult?.confidence ?? 0) > 0.8) {
          <span
            class="zev-status zev-status--success">
            {{ 'AUTOMATISCH_ERKANNT' | translate }}
          </span>
        }
        @if (matchResult?.matched && (matchResult?.confidence ?? 0) <= 0.8) {
          <span
            class="zev-status zev-status--warning">
            {{ 'BITTE_PRUEFEN' | translate }}
          </span>
        }
      </label>
      <select id="einheit" class="zev-select" name="einheit" [(ngModel)]="einheitId" required [disabled]="isMatching">
        @for (einheit of einheiten; track einheit) {
          <option [value]="einheit.id">
            {{ einheit.name }} ({{ einheit.typ }})
          </option>
        }
      </select>
    </div>

    <div class="zev-form-group">
      <label>{{ 'CSV_DATEI' | translate }}:</label>
      <div
        class="zev-drop-zone"
        [class.zev-drop-zone--active]="isDragOver"
        [class.zev-drop-zone--has-file]="file"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event)"
        (click)="fileInput.click()">
        <input
          #fileInput
          type="file"
          id="file"
          class="zev-drop-zone__input"
          name="file"
          accept=".csv"
          (change)="onFileChange($event)">
        @if (!file) {
          <div class="zev-drop-zone__content">
            <div class="zev-drop-zone__icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
            </div>
            <p class="zev-drop-zone__text">{{ 'DROP_CSV_HERE' | translate }}</p>
            <p class="zev-drop-zone__hint">{{ 'OR_CLICK_TO_SELECT' | translate }}</p>
          </div>
        }
        @if (file) {
          <div class="zev-drop-zone__file">
            <div class="zev-drop-zone__file-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <polyline points="10 9 9 9 8 9"/>
              </svg>
            </div>
            <div class="zev-drop-zone__file-info">
              <span class="zev-drop-zone__file-name">{{ file.name }}</span>
              <span class="zev-drop-zone__file-size">{{ formatFileSize(file.size) }}</span>
            </div>
            <button type="button" class="zev-drop-zone__remove" (click)="removeFile($event)" title="Entfernen">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>
        }
      </div>
    </div>

    <div class="zev-form-group">
      <label for="date">{{ 'DATUM' | translate }}:</label>
      <input type="date" id="date" class="zev-input" name="date" [(ngModel)]="date" required>
    </div>

    <button type="submit" class="zev-button zev-button--primary" [disabled]="uploading || isMatching || !date || !einheitId || !file">
      <app-icon name="upload"></app-icon>
      {{ uploading ? ('UPLOADING' | translate) : ('UPLOAD' | translate) }}
    </button>
  </form>
</div>